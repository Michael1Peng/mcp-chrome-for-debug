# Chrome浏览器自动化交互原型

## 系统架构流转图

```
整体架构组件关系
┌─────────────────┐     Native Message     ┌─────────────────┐     MCP Protocol     ┌─────────────────┐
│  Chrome扩展     │<──────────────────────→│   Native主机    │<────────────────────→│   MCP客户端      │
│  (Extension)    │                        │   (Native Host) │                      │   (Claude等)     │
└─────────────────┘                        └─────────────────┘                      └─────────────────┘
         │                                           │
         ↓                                           ↓
┌─────────────────┐                        ┌─────────────────┐
│ Background页面  │                        │  HTTP服务器     │
│ • 工具调用      │                        │  • /mcp端点     │
│ • 消息传递      │                        │  • /sse端点     │
│ • 状态管理      │                        │  • /ask-extension │
└─────────────────┘                        └─────────────────┘
         │
         ↓
┌─────────────────┐
│   Web页面       │
│ • DOM操作       │
│ • 页面交互      │
│ • 内容抓取      │
└─────────────────┘
```

## 消息流转协议图

```
消息传递时序图
MCP客户端           Native主机            Chrome扩展          Web页面
    │                  │                    │                 │
    │──工具调用请求─────→│                    │                 │
    │                  │──Native Message────→│                 │
    │                  │                    │──执行工具────────→│
    │                  │                    │←─返回结果────────│
    │                  │←─Native Response───│                 │
    │←─MCP响应─────────│                    │                 │
    │                  │                    │                 │

【消息类型说明】
┌────────────────────────────────────────┐
│ Native Message Types:                   │
├────────────────────────────────────────┤
│ • START/STARTED - 启动服务器           │
│ • STOP/STOPPED - 停止服务器            │
│ • PING/PONG - 心跳检测                 │
│ • PROCESS_DATA - 数据处理请求          │
│ • CALL_TOOL - 工具调用请求             │
│ • ERROR - 错误消息                     │
└────────────────────────────────────────┘
```

## 工具执行流程图

```
工具执行生命周期
┌───────────────┐
│   开始请求    │
└───────┬───────┘
        │
        ↓
┌───────────────┐
│ 参数验证与解析 │
└───────┬───────┘
        │
        ↓
┌───────────────┐    参数错误
│   参数校验    │────────────┐
└───────┬───────┘            │
        │ 参数正确            │
        ↓                    │
┌───────────────┐            │
│  获取目标标签  │            │
└───────┬───────┘            │
        │                    │
        ↓                    │
┌───────────────┐  标签不存在 │
│   标签验证    │────────────┤
└───────┬───────┘            │
        │ 标签存在            │
        ↓                    │
┌───────────────┐            │
│  执行具体操作  │            │
└───────┬───────┘            │
        │                    │
        ↓                    │
┌───────────────┐  操作失败   │
│   结果处理    │────────────┤
└───────┬───────┘            │
        │ 操作成功            │
        ↓                    ↓
┌───────────────┐     ┌──────────────┐
│   返回成功结果 │     │   返回错误响应│
└───────────────┘     └──────────────┘
```

## 浏览器交互操作图

```
【导航工具交互流程】
┌──────────────────────────────────────┐
│           NavigateTool               │
├──────────────────────────────────────┤
│ 输入参数：                           │
│ • url: 目标网址                      │
│ • newWindow: 是否新窗口              │
│ • refresh: 是否刷新                  │
│ • width/height: 窗口尺寸             │
├──────────────────────────────────────┤
│ 执行逻辑：                           │
│                                      │
│  刷新模式？                          │
│  ┌─YES─→ 刷新当前标签                │
│  NO                                  │
│  ↓                                   │
│  检查URL是否已打开                   │
│  ┌─YES─→ 激活已存在标签              │
│  NO                                  │
│  ↓                                   │
│  新窗口模式？                        │
│  ┌─YES─→ 创建新窗口                  │
│  NO                                  │
│  ↓                                   │
│  在现有窗口创建新标签                │
│                                      │
├──────────────────────────────────────┤
│ 返回结果：                           │
│ {                                    │
│   success: true/false,               │
│   tabId: 标签ID,                     │
│   windowId: 窗口ID,                  │
│   url: 实际URL                       │
│ }                                    │
└──────────────────────────────────────┘
```

```
【点击工具交互流程】
┌──────────────────────────────────────┐
│            ClickTool                 │
├──────────────────────────────────────┤
│ 输入参数：                           │
│ • selector: CSS选择器                │
│ • coordinates: 坐标点击              │
│ • waitForNavigation: 等待导航        │
│ • timeout: 超时时间                  │
├──────────────────────────────────────┤
│ 执行流程：                           │
│                                      │
│ ┌─────────────────────────────────┐  │
│ │  1. 注入点击辅助脚本             │  │
│ └─────────────────────────────────┘  │
│              │                       │
│              ↓                       │
│ ┌─────────────────────────────────┐  │
│ │  2. 定位目标元素                │  │
│ │     • CSS选择器模式             │  │
│ │     • 坐标模式                  │  │
│ └─────────────────────────────────┘  │
│              │                       │
│              ↓                       │
│ ┌─────────────────────────────────┐  │
│ │  3. 执行点击操作                │  │
│ │     • 模拟用户点击              │  │
│ │     • 触发事件                  │  │
│ └─────────────────────────────────┘  │
│              │                       │
│              ↓                       │
│ ┌─────────────────────────────────┐  │
│ │  4. 等待响应（可选）            │  │
│ │     • 页面导航                  │  │
│ │     • DOM变化                   │  │
│ └─────────────────────────────────┘  │
└──────────────────────────────────────┘
```

## 内容抓取交互图

```
【Web内容获取流程】
┌───────────────────────────────────────────────┐
│              WebFetcher                       │
├───────────────────────────────────────────────┤
│                                               │
│  目标页面判断                                 │
│  ┌─────────────┬─────────────┐               │
│  │ 指定URL     │ 当前活动标签│               │
│  └─────┬───────┴─────┬───────┘               │
│        │             │                       │
│        ↓             ↓                       │
│  ┌──────────┐  ┌─────────────┐              │
│  │ 导航到URL │  │ 使用现有标签 │              │
│  └─────┬────┘  └─────┬───────┘              │
│        └─────────────┼─────────────────┐    │
│                      ↓                 │    │
│              ┌───────────────┐         │    │
│              │ 注入内容脚本   │         │    │
│              └───────┬───────┘         │    │
│                      ↓                 │    │
│              ┌───────────────┐         │    │
│              │ 选择提取模式   │         │    │
│              └───────┬───────┘         │    │
│                      │                 │    │
│      ┌───────────────┼───────────────┐ │    │
│      ↓               ↓               ↓ │    │
│ ┌─────────┐  ┌─────────────┐  ┌────────┐   │
│ │HTML内容 │  │ 纯文本内容  │  │选择器内容│   │
│ └─────────┘  └─────────────┘  └────────┘   │
│      │               │               │     │
│      └───────────────┼───────────────┘     │
│                      ↓                     │
│              ┌───────────────┐             │
│              │ 格式化返回结果 │             │
│              └───────────────┘             │
└───────────────────────────────────────────────┘
```

```
【屏幕截图工具状态图】
┌──────────────────────────────────────┐
│        Screenshot State Flow         │
├──────────────────────────────────────┤
│                                      │
│    ┌─────────┐                      │
│    │  初始化  │                      │
│    └────┬────┘                      │
│         │                           │
│         ↓                           │
│    ┌─────────┐      参数验证失败     │
│    │ 参数验证 │────────────────┐     │
│    └────┬────┘                │     │
│         │ 参数正确             │     │
│         ↓                     │     │
│    ┌─────────┐                │     │
│    │获取目标页│                │     │
│    └────┬────┘                │     │
│         │                     │     │
│         ↓                     │     │
│    ┌─────────┐   注入脚本失败   │     │
│    │注入脚本 │────────────────┤     │
│    └────┬────┘                │     │
│         │ 注入成功             │     │
│         ↓                     │     │
│    ┌─────────┐                │     │
│    │执行截图 │                │     │
│    └────┬────┘                │     │
│         │                     │     │
│    ┌────┴────┐               │     │
│    │全屏？    │               │     │
│    └────┬────┘               │     │
│ YES     │     NO             │     │
│    ┌────↓────┐  ┌─────────┐  │     │
│    │ 全页截图 │  │元素截图 │  │     │
│    └────┬────┘  └────┬────┘  │     │
│         │            │       │     │
│         └────┬───────┘       │     │
│              ↓               │     │
│         ┌─────────┐          │     │
│         │处理结果 │          │     │
│         └────┬────┘          │     │
│              │               ���     │
│              ↓               ↓     │
│         ┌─────────┐     ┌─────────┐│
│         │返回成功 │     │ 返回错误││
│         └─────────┘     └─────────┘│
└──────────────────────────────────────┘
```

## 扩展程序生命周期图

```
Chrome扩展程序状态管理
┌─────────────────────────────────────────┐
│           Extension Lifecycle           │
├─────────────────────────────────────────┤
│                                         │
│    ┌───────────┐                       │
│    │Chrome启动 │                       │
│    └─────┬─────┘                       │
│          │                             │
│          ↓                             │
│    ┌───────────┐                       │
│    │扩展加载   │                       │
│    └─────┬─────┘                       │
│          │                             │
│          ↓                             │
│    ┌───────────┐     连接失败          │
│    │Native连接 │──────────┐            │
│    └─────┬─────┘          │            │
│          │ 连接成功        │            │
│          ↓                │            │
│    ┌───────────┐          │            │
│    │启动服务器 │          │            │
│    └─────┬─────┘          │            │
│          │                │            │
│          ↓                ↓            │
│    ┌───────────┐    ┌──────────┐      │
│    │ 运行状态  │    │ 错误状态 │      │
│    │• 接收请求 │    │• 重试连接│      │
│    │• 处理工具 │    │• 状态恢复│      │
│    │• 状态同步 │    └──────────┘      │
│    └─────┬─────┘                       │
│          │                             │
│          ↓                             │
│    ┌───────────┐                       │
│    │Chrome关闭 │                       │
│    └─────┬─────┘                       │
│          │                             │
│          ↓                             │
│    ┌───────────┐                       │
│    │清理资源   │                       │
│    └───────────┘                       │
└─────────────────────────────────────────┘
```

## 工具注册与调用机制

```
【MCP工具注册流程】
服务器启动
    ↓
┌─────────────────┐
│  MCP服务器初始化 │
└─────────┬───────┘
          │
          ↓
┌─────────────────┐
│   注册工具集合   │
│ • 浏览器导航工具 │
│ • 页面交互工具   │
│ • 内容抓取工具   │
│ • 截图工具       │
│ • 网络请求工具   │
│ • 历史记录工具   │
│ • 书签管理工具   │
└─────────┬───────┘
          │
          ↓
┌─────────────────┐
│  等待客户端连接  │
└─────────┬───────┘
          │
          ↓
┌─────────────────┐
│   工具调用处理   │
│ 1. 验证工具名称  │
│ 2. 参数校验      │
│ 3. 转发到扩展    │
│ 4. 等待响应      │
│ 5. 返回结果      │
└─────────────────┘
```
