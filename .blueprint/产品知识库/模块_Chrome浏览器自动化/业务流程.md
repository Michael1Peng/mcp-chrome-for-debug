# Chrome浏览器自动化 - 业务流程分析

## 项目概述

Chrome浏览器自动化项目是一个基于MCP (Model Context Protocol) 协议的浏览器自动化解决方案，通过Native Server和Chrome扩展的协作，为AI系统提供完整的浏览器操作能力。

## 核心架构

项目采用三层架构设计：

- **MCP客户端层**：接收用户指令，发送工具调用请求
- **Native Server层**：HTTP服务器，实现MCP协议，负责请求路由
- **Chrome扩展层**：浏览器端执行器，实现具体的浏览器操作

## 主要业务流程

### 1. 端到端自动化流程

```
Chrome浏览器自动化 - 端到端流程
┌─────────────┬──────────────────────────────────────────────────────────────────────────────────┐
│    角色      │                                      流程                                            │
├─────────────┼──────────────────────────────────────────────────────────────────────────────────┤
│             │     ┌─────┐                                                                        │
│  MCP客户端   │     │开始 │                                                                        │
│             │     └──┬──┘                                                                        │
│             │        ↓                                                                           │
│             │     ┌─────────┐    ┌──────────┐    ┌──────────────┐                            │
│             │     │构建请求 ├───→│发送HTTP  ├───→│等待响应      │                            │
│             │     └─────────┘    │请求      │    └──────┬───────┘                            │
│             │                    └──────────┘           ↓                                      │
├─────────────┼────────────────────────────────────────────────────────────────────────────────┤
│             │                                  ┌──────────────┐                              │
│ Native      │                                  │接收HTTP请求  │                              │
│ Server      │                                  └──────┬───────┘                              │
│             │                                         ↓                                        │
│             │                            ◇─────────────◇                                     │
│             │                           ╱  MCP协议验证   ╲      失败                          │
│             │                          ╱   是否通过      ╲────→[返回错误]                    │
│             │                         ╲                 ╱                                     │
│             │                          ╲               ╱                                       │
│             │                           ◇─────────────◇                                       │
│             │                                  ↓成功                                          │
│             │                          ┌──────────────┐                                      │
│             │                          │转发到Chrome  │                                      │
│             │                          │扩展          │                                      │
│             │                          └──────┬───────┘                                      │
├─────────────┼───────────────────────────────────────────────────────────────────────────────┤
│             │                                 ↓                                              │
│ Chrome      │                      ┌──────────────┐                                          │
│ 扩展        │                      │接收Native    │                                          │
│             │                      │Messaging消息 │                                          │
│             │                      └──────┬───────┘                                          │
│             │                             ↓                                                   │
│             │                      ┌──────────────┐                                          │
│             │                      │解析工具调用  │                                          │
│             │                      └──────┬───────┘                                          │
│             │                             ↓                                                   │
│             │                    ◇─────────────◇                                             │
│             │                   ╱   工具类型     ╲                                          │
│             │     ┌──────────── ╱    判断        ╲ ──────────┐                             │
│             │     ↓            ╲                 ╱           ↓                               │
│             │ ┌─────────┐       ╲               ╱      ┌──────────┐                        │
│             │ │页面操作 │        ◇─────────────◇       │网络请求  │                        │
│             │ └────┬────┘                              └────┬─────┘                        │
│             │      ↓                                        ↓                               │
├─────────────┼────────────────────────────────────────────────────────────────────────────────┤
│             │      ↓                                        ↓                               │
│ 浏览器      │ ┌──────────────┐                      ┌──────────────┐                      │
│ 环境        │ │执行DOM操作   │                      │发起网络请求  │                      │
│             │ │• 点击元素    │                      │• HTTP请求    │                      │
│             │ │• 填充表单    │                      │• 捕获响应    │                      │
│             │ │• 截图       │                      └──────┬───────┘                      │
│             │ │• 导航       │                              ↓                               │
│             │ └──────┬───────┘                      ┌──────────────┐                      │
│             │        ↓                              │返回网络数据  │                      │
│             │ ┌──────────────┐                      └──────┬───────┘                      │
│             │ │返回操作结果  │                             │                               │
│             │ └──────┬───────┘                             │                               │
│             │        ↓                                     ↓                               │
│             │        └─────────────┬──────────────────────┘                               │
│             │                      ↓                                                       │
│             │              ┌──────────────┐                                              │
│             │              │返回执行结果  │                                              │
│             │              └──────┬───────┘                                              │
│             │                     ↓                                                       │
│             │              ┌─────────┐                                                   │
│             │              │  完成   │                                                   │
│             │              └─────────┘                                                   │
└─────────────┴──────────────────────────────────────────────────────────────────────────────────┘

图例说明：
┌─┐ 开始/结束    ┌──┐ 操作/活动    ◇ 判断/决策    → 流程方向
```

### 2. 工具调用处理流程

```
工具调用处理流程
                    ┌──────────┐
                    │MCP工具请求│
                    └────┬─────┘
                         ↓
                    ┌──────────┐
                    │HTTP接收  │
                    └────┬─────┘
                         ↓
                    ◇─────────◇
                   ╱  请求验证 ╲
                  ╱   是否有效  ╲───否───→ [返回400错误]
                 ╲            ╱
                  ╲          ╱
                   ◇────┬───◇
                        │是
                        ↓
                   ┌──────────┐
                   │Native    │
                   │Messaging │←─────────┐
                   │转发      │          │
                   └────┬─────┘          │
                        ↓                │
                   ┌──────────┐          │
                   │Chrome    │          │超时
                   │扩展处理  │          │
                   └────┬─────┘          │
                        ↓                │
                   ◇─────────◇           │
                  ╱  工具存在 ╲          │
                 ╱   检查     ╲──否──────┘
                ╲            ╱
                 ╲          ╱
                  ◇────┬───◇
                       │是
                       ↓
                  ┌──────────┐
                  │执行工具  │
                  │业务逻辑  │
                  └────┬─────┘
                       ↓
                  ┌──────────┐
                  │返回结果  │
                  └────┬─────┘
                       ↓
                  ┌──────────┐
                  │JSON格式化│
                  └────┬─────┘
                       ↓
                  ┌──────────┐
                  │HTTP响应  │
                  └────┬─────┘
                       ↓
                  ┌──────────┐
                  │   完成    │
                  └──────────┘
```

### 3. 页面自动化操作流程

```
页面自动化操作流程
┌─────────────┬──────────────────────────────────────────────────────────────────────────────────┐
│    操作类型  │                                      流程                                            │
├─────────────┼──────────────────────────────────────────────────────────────────────────────────┤
│             │     ┌─────────┐                                                                    │
│  页面导航    │     │接收URL  │                                                                    │
│             │     └────┬────┘                                                                    │
│             │          ↓                                                                         │
│             │     ┌─────────┐    ┌──────────┐    ┌──────────────┐                            │
│             │     │创建标签页├───→│等待加载  ├───→│返回页面信息  │                            │
│             │     └─────────┘    └──────────┘    └──────────────┘                            │
├─────────────┼────────────────────────────────────────────────────────────────────────────────┤
│             │     ┌─────────┐                                                                    │
│  元素交互    │     │定位元素 │                                                                    │
│             │     └────┬────┘                                                                    │
│             │          ↓                                                                         │
│             │     ◇─────────◇                                                                   │
│             │    ╱  元素存在 ╲                                                                  │
│             │   ╱   检查     ╲──否──→ [返回未找到错误]                                        │
│             │  ╲            ╱                                                                   │
│             │   ╲          ╱                                                                     │
│             │    ◇────┬───◇                                                                     │
│             │         │是                                                                       │
│             │         ↓                                                                         │
│             │    ┌──────────┐    ┌──────────┐    ┌──────────────┐                            │
│             │    │执行操作  ├───→│等待响应  ├───→│返回操作结果  │                            │
│             │    │• 点击    │    │• 导航    │    │• 状态变化    │                            │
│             │    │• 填充    │    │• 动画    │    │• 元素状态    │                            │
│             │    │• 键盘    │    │• 加载    │    │• 页面更新    │                            │
│             │    └──────────┘    └──────────┘    └──────────────┘                            │
├─────────────┼────────────────────────────────────────────────────────────────────────────────┤
│             │     ┌─────────┐                                                                    │
│  内容提取    │     │选择方式 │                                                                    │
│             │     └────┬────┘                                                                    │
│             │          ↓                                                                         │
│             │     ◇─────────◇                                                                   │
│             │    ╱  提取类型 ╲                                                                  │
│             │   ╱           ╲                                                                   │
│             │  ╱  HTML/TEXT  ╲                                                                  │
│             │ ╱     选择      ╲                                                                 │
│             │ ╲             ╱                                                                   │
│             │  ╲           ╱                                                                     │
│             │   ╲         ╱                                                                      │
│             │    ◇───┬───◇                                                                      │
│             │        ↓                                                                           │
│             │   ┌──────────┐    ┌──────────┐    ┌──────────────┐                            │
│             │   │获取内容  ├───→│格式化    ├───→│返回文档结构  │                            │
│             │   │• DOM结构 │    │• 清理    │    │• 文本内容    │                            │
│             │   │• 文本    │    │• 压缩    │    │• 元数据      │                            │
│             │   │• 元数据  │    │• 编码    │    │• 链接信息    │                            │
│             │   └──────────┘    └──────────┘    └──────────────┘                            │
├─────────────┼────────────────────────────────────────────────────────────────────────────────┤
│             │     ┌─────────┐                                                                    │
│  网络监控    │     │开启捕获 │                                                                    │
│             │     └────┬────┘                                                                    │
│             │          ↓                                                                         │
│             │     ┌─────────┐    ┌──────────┐    ┌──────────────┐                            │
│             │     │注册监听器├───→│收集请求  ├───→│存储网络数据  │                            │
│             │     │• WebReq │    │• Headers │    │• 请求/响应    │                            │
│             │     │• Debugger│    │• Body    │    │• 时间戳      │                            │
│             │     └─────────┘    │• 状态码  │    │• 性能数据    │                            │
│             │                    └────��─────┘    └──────┬───────┘                            │
│             │                                           ↓                                      │
│             │                                    ┌──────────────┐                            │
│             │                                    │停止捕获并    │                            │
│             │                                    │返回汇总数据  │                            │
│             │                                    └──────────────┘                            │
└─────────────┴──────────────────────────────────────────────────────────────────────────────────┘

图例说明：
┌─┐ 开始/结束    ┌──┐ 操作/活动    ◇ 判断/决策    → 流程方向
```

## 核心功能模块

### 浏览器控制工具

- **页面导航**：chrome_navigate - 导航到指定URL或刷新页面
- **标签管理**：get_windows_and_tabs, chrome_close_tabs - 管理浏览器窗口和标签页
- **页面截图**：chrome_screenshot - 截取页面或元素截图

### 页面交互工具

- **元素点击**：chrome_click_element - 点击页面元素或坐标
- **表单填充**：chrome_fill_or_select - 填充输入框或选择下拉选项
- **键盘模拟**：chrome_keyboard - 模拟键盘输入事件
- **交互元素**：chrome_get_interactive_elements - 获取可交互元素列表

### 内容提取工具

- **内容获取**：chrome_get_web_content - 提取页面HTML或文本内容
- **语义搜索**：search_tabs_content - 在打开的标签页中搜索相关内容
- **控制台日志**：chrome_console - 捕获浏览器控制台输出

### 网络监控工具

- **网络请求**：chrome_network_request - 发送HTTP请求
- **请求捕获**：chrome_network_capture_start/stop - 监控网络请求
- **调试器捕获**：chrome_network_debugger_start/stop - 使用Chrome调试器API捕获网络数据

### 浏览器数据工具

- **历史记录**：chrome_history - 搜索和获取浏览历史
- **书签管理**：chrome_bookmark_search/add/delete - 书签的搜索、添加和删除

### 脚本注入工具

- **脚本注入**：chrome_inject_script - 向页面注入JavaScript代码
- **脚本通信**：chrome_send_command_to_inject_script - 与注入脚本通信

## 用户故事

### 1. 网页自动化测试

**作为**一个QA工程师
**我希望**能够自动化测试网页功能
**以便**提高测试效率和覆盖率

**验收标准**：

- 能够导航到测试页面
- 能够自动填写表单并提交
- 能够验证页面元素和内容
- 能够截图保存测试证据

### 2. 数据采集爬虫

**作为**一个数据分析师
**我希望**能够自动提取网页数据
**以便**进行数据分析和报告��成

**验收标准**：

- 能够批量访问网页列表
- 能够提取结构化数据
- 能够处理动态加载内容
- 能够监控网络请求和API调用

### 3. 用户行为模拟

**作为**一个产品经理
**我希望**能够模拟用户操作流程
**以便**测试用户体验和发现问题

**验收标准**：

- 能够模拟真实的用户点击和输入
- 能够处理复杂的交互场景
- 能够记录操作过程和结果
- 能够生成用户行为报告

## 技术架构要点

### 通信机制

- **HTTP API**：MCP客户端与Native Server通信
- **Native Messaging**：Native Server与Chrome扩展通信
- **Chrome Extensions API**：扩展与浏览器交互

### 安全考虑

- **Origin验证**：限制扩展通信来源
- **权限控制**：基于Chrome扩展权限系统
- **数据隔离**：工具调用结果独立处理

### 性能优化

- **异步处理**：所有操作均采用异步模式
- **超时机制**：防止操作阻塞
- **资源管理**：及时清理浏览器资源

## 错误处理策略

### 网络错误

- 连接超时：自动重试机制
- 网络异常：返回详细错误信息
- 权限拒绝：提示用户权限问题

### 页面操作错误

- 元素未找到：返回定位失败信息
- 操作超时：提供超时配置选项
- 页面加载失败：返回加载状态

### 扩展通信错误

- 消息丢失：实现请求-响应确认机制
- 扩展未响应：超时检测和错误回调
- 格式错误：参数验证和类型检查
