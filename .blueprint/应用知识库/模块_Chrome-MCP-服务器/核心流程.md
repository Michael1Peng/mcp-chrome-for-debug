# Chrome MCP Server - 核心流程分析

## 整体架构图

```
MCP协议通信流程
==================

[AI客户端] ──→ [Native服务器] ──→ [Chrome扩展] ──→ [浏览器API]
    │            │              │              │
    ▼            ▼              ▼              ▼
Claude/任意客户端 Fastify HTTP  Background脚本   Chrome APIs
@MCP客户端      @Server.ts     @index.ts      @原生接口
    │            │              │              │
    │            │              ▼              │
    │            │         工具执行器           │
    │            │         @tools/index.ts    │
    │            │              │              │
    │            ▼              ▼              ▼
    │       native-messaging   浏览器操作      页面交互
    │       @native-host.ts    @browser/*     @内容脚本
    │            │              │              │
    └────────────┼──────────────┼──────────────┘
                 │              │
                 ▼              ▼
            MCP响应返回      工具结果收集
```

## 服务器启动流程

```
服务器初始化序列
================

[程序入口] ──→ [服务器实例] ──→ [Native Host] ──→ [扩展连接]
     │             │             │             │
     ▼             ▼             ▼             ▼
index.ts ──→ Server.constructor ──→ NativeHost.start ──→ Extension.connect
@入口文件    @server/index.ts    @native-messaging-host.ts @background/index.ts
     │             │             │             │
     │             ▼             │             │
     │         Fastify启动       │             │
     │         ports: 12306      │             │
     │             │             │             │
     ▼             ▼             ▼             ▼
setNativeHost  setupRoutes   stdio监听      initListeners
关联依赖        路由配置      进程通信        消息监听器
```

## 工具调用执行流程

```
工具调用完整生命周期
==================

[MCP请求] ──→ [路由分发] ──→ [消息传递] ──→ [工具执行] ──→ [结果返回]
     │           │           │           │           │
     ▼           ▼           ▼           ▼           ▼
POST /mcp   StreamableHTTP   Native MSG   handleCallTool  MCP Response
@Server.ts  @Transport层     @native-host  @tools/index.ts @Transport层
     │           │           │           │           │
     │           │           ▼           │           │
     │           │       Port通信       │           │
     │           │       chrome.runtime │           │
     │           │           │           │           │
     ▼           ▼           ▼           ▼           ▼
MCP解析     会话管理      消息路由     工具查找     响应序列化
协议处理     sessionId    消息类型     工具映射     JSON格式

工具执行分支:
============

浏览器管理工具 ──→ chrome.tabs API
页面交互工具   ──→ 内容脚本注入
网络监控工具   ──→ chrome.webRequest/debugger
内容分析工具   ──→ 语义相似度引擎
截图工具       ──→ chrome.tabs.captureVisibleTab
```

## AI语义处理流程

```
语义相似度引擎处理流程
==================

[内容获取] ──→ [文本分块] ──→ [向量化] ──→ [相似度计算] ──→ [结果排序]
     │           │           │           │           │
     ▼           ▼           ▼           ▼           ▼
chrome_get_web  TextChunker  SemanticEngine SIMD计算   相似度排序
@web-content.ts @text-chunker @semantic-engine @simd-math @vector-database
     │           │           │           │           │
     │           ▼           │           │           │
     │       固定长度切分     │           │           │
     │       overlap处理     │           │           │
     │           │           │           │           │
     ▼           ▼           ▼           ▼           ▼
DOM内容提取   文本预处理    BGE模型推理   余弦相似度   HNSW索引

SIMD加速分支:
============

WebAssembly ──→ Rust实现 ──→ f32x4 SIMD ──→ 4-8x性能提升
@wasm-simd     @simd-math    @向量运算      @批量计算
     │           │           │           │
     ▼           ▼           ▼           ▼
内存池管理    并行计算      向量操作      缓存优化
```

## 扩展消息通信流程

```
Chrome扩展内部通信
================

[Background] ←──→ [Content Script] ←──→ [Popup] ←──→ [Offscreen]
      │              │                 │           │
      ▼              ▼                 ▼           ▼
消息中枢处理      页面操作执行       用户界面      AI模型处理
@background/     @content.ts        @popup/      @offscreen/
      │              │                 │           │
      │              ▼                 │           │
      │          脚本注入               │           │
      │          DOM操作               │           │
      │              │                 │           │
      ▼              ▼                 ▼           ▼
native-host      元素查找            状态显示     模型推理
原生消息通信      点击填充             配置管理     向量计算

消息类型分发:
===========

CALL_TOOL        ──→ 工具执行
PROCESS_DATA     ──→ 数据处理
SERVER_STARTED   ──→ 服务状态
CONNECT_NATIVE   ──→ 连接建立
PING_NATIVE      ──→ 连接检测
```

## 关键文件和函数映射

### 核心启动文件

- `app/native-server/src/index.ts` - 程序入口点
- `app/native-server/src/server/index.ts:Server.start()` - HTTP服务器启动
- `app/chrome-extension/entrypoints/background/index.ts` - 扩展后台脚本入口

### 主要工具执行器

- `app/chrome-extension/entrypoints/background/tools/index.ts:handleCallTool()` - 工具调用分发
- `app/chrome-extension/entrypoints/background/tools/browser/` - 浏览器工具集合
- `app/chrome-extension/entrypoints/background/native-host.ts:connectNativeHost()` - 原生通信

### AI处理核心

- `app/chrome-extension/utils/semantic-similarity-engine.ts` - 语义引擎
- `packages/wasm-simd/` - SIMD加速模块
- `app/chrome-extension/utils/vector-database.ts` - 向量数据库

### 通信桥接层

- `app/native-server/src/native-messaging-host.ts` - 原生消息宿主
- `app/native-server/src/mcp/mcp-server.ts:getMcpServer()` - MCP服务器实例
- `app/native-server/src/mcp/register-tools.ts` - 工具注册器

## 数据传递路径

```
请求数据流转
===========

AI客户端JSON ──→ MCP协议解析 ──→ HTTP POST ──→ Native Message ──→ Chrome API
    │              │              │              │              │
    ▼              ▼              ▼              ▼              ▼
工具参数       工具调用请求     Fastify路由     Port通信      原生API调用
@args对象     @ToolCall类型    @/mcp endpoint  @runtime      @chrome.*

响应数据回流
===========

API结果 ──→ 扩展处理 ──→ Native响应 ──→ HTTP响应 ──→ MCP结果 ──→ AI客户端
   │           │           │           │           │           │
   ▼           ▼           ▼           ▼           ▼           ▼
原始数据    结果包装     消息封装     JSON序列化   协议包装    客户端处理
@API返回   @tool结果   @响应对象   @HTTP body  @MCP格式   @最终展示
```
