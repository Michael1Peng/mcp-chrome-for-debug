# Chrome-MCP-服务器 数据流设计分析

## 项目架构概述

Chrome-MCP-服务器是一个基于Model Context Protocol (MCP)的Chrome浏览器自动化工具，通过Native Messaging Host连接Chrome Extension和本地服务器，实现AI与浏览器的深度交互。

## 核心数据流图

### 1. 服务器启动与通信建立数据流

```
Chrome Extension Background ──→ Native Messaging Host ──→ Server Instance ──→ MCP Server
         │                              │                        │               │
         ▼                              ▼                        ▼               ▼
    connectNativeHost()           setupMessageHandling()     start(port)    getMcpServer()
    @native-host.ts               @native-messaging-host     @server/index  @mcp/mcp-server
         │                              │                        │               │
         ▼                              ▼                        ▼               ▼
    runtime.connectNative()        stdin事件监听               Fastify实例     Server实例创建
    建立Native连接                  消息协议处理                HTTP服务启动     setupTools()
         │                              │                        │               │
         ▼                              ▼                        ▼               ▼
    发送START消息                  handleMessage()             路由注册完成      工具注册完成
    NativeMessageType.START       消息分发处理                服务状态更新      MCP协议就绪
```

### 2. 工具调用请求响应数据流

```
外部MCP客户端 ──→ HTTP接口 ──→ Native Host ──→ Extension工具 ──→ Chrome APIs
      │               │            │             │              │
      ▼               ▼            ▼             ▼              ▼
  POST /ask-extension  解析请求参数   sendRequestTo  handleCallTool  chrome.tabs.*
  @server/index.ts    query提取      ExtensionAnd   @tools/index    chrome.runtime.*
      │               │            Wait()          │              │
      ▼               ▼            │             ▼              ▼
  验证服务状态         包装消息格式     │         工具路由分发        执行浏览器操作
  isRunning检查       ExtensionRequest │         tools[toolName]   DOM/页面交互
      │               Payload构造     │             │              │
      ▼               ▼            ▼             ▼              ▼
  调用nativeHost      等待Extension   消息ID管理     返回ToolResult   操作结果收集
  超时管理机制        响应回调        pendingRequests content数组    success/error
```

### 3. MCP协议消息处理数据流

```
MCP客户端 ──→ HTTP传输层 ──→ Session管理 ──→ MCP Server ──→ 工具执行器
    │            │            │            │            │
    ▼            ▼            ▼            ▼            ▼
initialize请求  POST/GET /mcp  sessionId生成  connect()   register-tools
@外部客户端     @server/index  transportsMap  @mcp-server @register-tools
    │            │            │            │            │
    ▼            ▼            ▼            ▼            ▼
协议握手阶段    传输层协商      会话状态维护    SDK连接建立   setupTools()
认证与能力交换   StreamableHTTP  UUID管理       transport绑定  工具能力注册
    │            │            │            │            │
    ▼            ▼            ▼            ▼            ▼
tool_call请求   handleRequest() onSessionInit  处理工具调用    实际工具执行
参数验证       请求路由分发     cleanup管理     callTool()     浏览器API调用
```

### 4. Chrome Extension内部数据流

```
Background Script ──→ Tool Handler ──→ Browser Tools ──→ Content Scripts
      │                   │               │               │
      ▼                   ▼               ▼               ▼
  initNativeHost      handleCallTool    execute(args)   inject-scripts
  @background/index   @tool-handler     @tools/browser  @inject-scripts
      │                   │               │               │
      ▼                   ▼               ▼               ▼
  监听器初始化           工具路由分发        具体工具实现      页面脚本注入
  消息处理注册           switch(toolName)   screenshot      click-helper
      │                   │               interaction     fill-helper
      ▼                   ▼               web-fetcher     keyboard-helper
  状态管理更新           createError       network-capture  element-helper
  serverStatus          Response          bookmark-ops    │
      │                   │               history-ops     ▼
      ▼                   ▼               window-ops      DOM操作执行
  广播状态变化           ToolResult返回     console-ops     事件模拟触发
  broadcastStatus       content数组        │               页面内容读取
                                         ▼
                                    API调用结果
                                    chrome.*接口
```

### 5. 存储与状态管理数据流

```
Chrome Storage ──→ StorageManager ──→ Extension State ──→ Native Host Status
      │                │                  │                   │
      ▼                ▼                  ▼                   ▼
  chrome.storage     initStorage       currentServer       ServerStatus
  .local/.sync       ManagerListener   Status对象          接口定义
  @Chrome APIs       @storage-manager  @native-host        │
      │                │                  │                   ▼
      ▼                ▼                  ▼               isRunning状态
  持久化存储          存储事件监听         内存状态缓存        port端口信息
  键值对数据          数据同步处理         lastUpdated时戳     lastUpdated时戳
      │                │                  │                   │
      ▼                ▼                  ▼                   ▼
  STORAGE_KEYS       saveServerStatus    loadServerStatus    broadcastServer
  配置常量管理        状态持久化保存       启动时状态恢复       StatusChange()
                                                           状态变化广播
```

### 6. 错误处理与消息传递数据流

```
异常源头 ──→ 错误捕获 ──→ 错误包装 ──→ 错误传播 ──→ 错误响应
    │           │          │          │          │
    ▼           ▼          ▼          ▼          ▼
Chrome API   try-catch   createError  Promise.   客户端接收
调用失败     @各层组件    Response     reject     错误信息
    │           │          │          │          │
    ▼           ▼          ▼          ▼          ▼
工具执行异常   异常信息提取  ToolResult  nativePort  HTTP响应
超时错误      error.message  isError:true postMessage error status
    │           │          │          │          │
    ▼           ▼          ▼          ▼          ▼
网络连接失败   日志记录     content数组   响应ID映射   客户端处理
端口冲突      console.error text类型    requestId   重试逻辑
```

## 关键数据结构

### ServerStatus 接口

```typescript
// @native-host.ts:19
interface ServerStatus {
  isRunning: boolean;
  port?: number;
  lastUpdated: number;
}
```

### ToolResult 接口

```typescript
// @tool-handler.ts:3
interface ToolResult extends CallToolResult {
  content: (TextContent | ImageContent)[];
  isError: boolean;
}
```

### PendingRequest 接口

```typescript
// @native-messaging-host.ts:7
interface PendingRequest {
  resolve: (value: any) => void;
  reject: (reason?: any) => void;
  timeoutId: NodeJS.Timeout;
}
```

## 核心文件索引

- **入口文件**: `app/native-server/src/index.ts:5`
- **MCP服务器**: `app/native-server/src/mcp/mcp-server.ts:10`
- **Native Host**: `app/native-server/src/native-messaging-host.ts:13`
- **HTTP服务器**: `app/native-server/src/server/index.ts:22`
- **Extension背景**: `app/chrome-extension/entrypoints/background/index.ts:13`
- **Native连接**: `app/chrome-extension/entrypoints/background/native-host.ts:76`
- **工具处理器**: `app/chrome-extension/common/tool-handler.ts:8`
- **工具注册**: `app/native-server/src/mcp/register-tools.ts`
