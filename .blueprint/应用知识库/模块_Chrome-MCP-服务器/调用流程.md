# Chrome-MCP-服务器 函数调用关系流程图

## 流程图1: 主程序启动和初始化流程

```
主程序启动初始化链
====================

index.ts main entry@app/native-server/src/index.ts
    ↓ 传递: void
serverInstance creation@app/native-server/src/server/index.ts
    ↓ 传递: Server instance
nativeMessagingHostInstance creation@app/native-server/src/native-messaging-host.ts
    ↓ 传递: NativeMessagingHost instance
serverInstance.setNativeHost(nativeMessagingHostInstance)@app/native-server/src/index.ts
    ↓ 传递: NativeMessagingHost reference
nativeMessagingHostInstance.setServer(serverInstance)@app/native-server/src/index.ts
    ↓ 传递: Server reference
nativeMessagingHostInstance.start()@app/native-server/src/index.ts
    ↓ 传递: void
setupMessageHandling()@app/native-server/src/native-messaging-host.ts
    ↓ 传递: stdin/stdout stream setup
```

## 流程图2: MCP服务器初始化和工具注册流程

```
MCP服务器初始化和工具注册链
==============================

getMcpServer()@app/native-server/src/mcp/mcp-server.ts
    ↓ 传递: void
Server instance creation@app/native-server/src/mcp/mcp-server.ts
    ↓ 传递: {name: 'ChromeMcpServer', version: '1.0.0', capabilities: {tools: {}}}
setupTools(mcpServer)@app/native-server/src/mcp/mcp-server.ts
    ↓ 传递: Server instance
server.setRequestHandler(ListToolsRequestSchema)@app/native-server/src/mcp/register-tools.ts
    ↓ 传递: async () => ({tools: TOOL_SCHEMAS})
server.setRequestHandler(CallToolRequestSchema)@app/native-server/src/mcp/register-tools.ts
    ↓ 传递: async (request) => handleToolCall(request.params.name, request.params.arguments)
TOOL_SCHEMAS loading@packages/shared/src/tools.ts
    ↓ 传递: Tool[] array with all available tool definitions
```

## 流程图3: HTTP服务器启动和路由注册流程

```
HTTP服务器初始化和路由注册链
================================

Server constructor@app/native-server/src/server/index.ts
    ↓ 传递: void
Fastify instance creation@app/native-server/src/server/index.ts
    ↓ 传递: {logger: SERVER_CONFIG.LOGGER_ENABLED}
setupPlugins()@app/native-server/src/server/index.ts
    ↓ 传递: void
fastify.register(cors)@app/native-server/src/server/index.ts
    ↓ 传递: {origin: SERVER_CONFIG.CORS_ORIGIN}
setupRoutes()@app/native-server/src/server/index.ts
    ↓ 传递: void

路由注册分支:
fastify.get('/ask-extension')@app/native-server/src/server/index.ts
    ↓ 传递: ExtensionRequestPayload handler
fastify.get('/sse')@app/native-server/src/server/index.ts
    ↓ 传递: SSE connection handler
fastify.post('/messages')@app/native-server/src/server/index.ts
    ↓ 传递: SSE message handler
fastify.post('/mcp')@app/native-server/src/server/index.ts
    ↓ 传递: MCP HTTP transport handler
fastify.get('/mcp')@app/native-server/src/server/index.ts
    ↓ 传递: MCP SSE transport handler
fastify.delete('/mcp')@app/native-server/src/server/index.ts
    ↓ 传递: MCP session deletion handler
```

## 流程图4: 工具调用处理流程

```
工具调用请求处理链
==================

handleToolCall(name, args)@app/native-server/src/mcp/register-tools.ts
    ↓ 传递: {name: string, args: any}
nativeMessagingHostInstance.sendRequestToExtensionAndWait()@app/native-server/src/mcp/register-tools.ts
    ↓ 传递: {name, args}, NativeMessageType.CALL_TOOL, 30000ms timeout
NativeMessagingHost message processing@app/native-server/src/native-messaging-host.ts
    ↓ 传递: JSON message through stdin/stdout
Chrome Extension processing@app/chrome-extension/entrypoints/background/native-host.ts
    ↓ 传递: native message via chrome.runtime.connectNative()
handleCallTool()@app/chrome-extension/entrypoints/background/tools/index.ts
    ↓ 传递: tool name and arguments
Tool execution分支@各个具体工具文件
    ↓ 传递: tool-specific parameters
Response chain back@app/chrome-extension/entrypoints/background/native-host.ts
    ↓ 传递: {status: 'success'|'error', data|error: result}
CallToolResult formatting@app/native-server/src/mcp/register-tools.ts
    ↓ 传递: {content: [{type: 'text', text: string}], isError?: boolean}
```

## 流程图5: Chrome扩展后台服务初始化流程

```
Chrome扩展后台服务初始化链
============================

defineBackground()@app/chrome-extension/entrypoints/background/index.ts
    ↓ 传递: background script entry function
initNativeHostListener()@app/chrome-extension/entrypoints/background/index.ts
    ↓ 传递: void
initSemanticSimilarityListener()@app/chrome-extension/entrypoints/background/index.ts
    ↓ 传递: void
initStorageManagerListener()@app/chrome-extension/entrypoints/background/index.ts
    ↓ 传递: void
initializeSemanticEngineIfCached()@app/chrome-extension/entrypoints/background/index.ts
    ↓ 传递: Promise<boolean> initialization status
cleanupModelCache()@app/chrome-extension/entrypoints/background/index.ts
    ↓ 传递: cache cleanup operation

Native Host连接分支:
chrome.runtime.connectNative(HOST_NAME)@app/chrome-extension/entrypoints/background/native-host.ts
    ↓ 传递: native messaging port connection
nativePort.onMessage.addListener()@app/chrome-extension/entrypoints/background/native-host.ts
    ↓ 传递: message handler function
nativePort.onDisconnect.addListener()@app/chrome-extension/entrypoints/background/native-host.ts
    ↓ 传递: disconnect handler function
```

## 流程图6: MCP传输层会话管理流程

```
MCP传输层会话管理链
====================

StreamableHTTPServerTransport creation@app/native-server/src/server/index.ts
    ↓ 传递: {sessionIdGenerator: () => newSessionId, onsessioninitialized: callback}
SSEServerTransport creation@app/native-server/src/server/index.ts
    ↓ 传递: '/messages' endpoint, reply.raw response stream
transportsMap.set(sessionId, transport)@app/native-server/src/server/index.ts
    ↓ 传递: transport instance storage
getMcpServer().connect(transport)@app/native-server/src/server/index.ts
    ↓ 传递: transport connection to MCP server
transport.handleRequest(request.raw, reply.raw)@app/native-server/src/server/index.ts
    ↓ 传递: HTTP request/response handling

会话清理分支:
transport.onclose@app/native-server/src/server/index.ts
    ↓ 传递: cleanup callback
transportsMap.delete(sessionId)@app/native-server/src/server/index.ts
    ↓ 传递: session removal from active sessions
reply.raw.on('close')@app/native-server/src/server/index.ts
    ↓ 传递: client disconnect detection
request.socket.on('close')@app/native-server/src/server/index.ts
    ↓ 传递: SSE client disconnect handling
```

## 流程图7: 工具名称解析和分发流程

```
工具名称解析和分发链
====================

TOOL_NAMES constant@packages/shared/src/tools.ts
    ↓ 传递: tool name mappings
TOOL_SCHEMAS array@packages/shared/src/tools.ts
    ↓ 传递: complete tool definitions with schemas
handleCallTool(name, args)@app/chrome-extension/entrypoints/background/tools/index.ts
    ↓ 传递: tool name string and arguments object

工具分发分支:
switch(toolName)@app/chrome-extension/entrypoints/background/tools/index.ts
    ↓ 条件分发到各个工具处理器

BROWSER工具分支:
'chrome_navigate' → navigate()@app/chrome-extension/entrypoints/background/tools/browser/common.ts
'chrome_screenshot' → screenshot()@app/chrome-extension/entrypoints/background/tools/browser/screenshot.ts
'chrome_click_element' → click()@app/chrome-extension/entrypoints/background/tools/browser/click.ts
'chrome_get_web_content' → webFetcher()@app/chrome-extension/entrypoints/background/tools/browser/web-fetcher.ts
'chrome_console' → console()@app/chrome-extension/entrypoints/background/tools/browser/console.ts
    ↓ 传递: tool-specific execution and result formatting
```
